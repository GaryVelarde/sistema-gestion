<p-toast key="tst"></p-toast>
<div *ngIf="!inscriptionSelected" class="grid">
    <div class="col-12">
        <div class="card px-6 py-6">
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <div class="my-2">
                        <button
                            pButton
                            pRipple
                            label="Inscribir un nuevo protecto de tesis"
                            icon="pi pi-plus"
                            class="p-button-success mr-2"
                            (click)="goToInscription()"></button>
                    </div>
                </ng-template>
            </p-toolbar>
            <div class="card">
                <p-table #dt [value]="registros" responsiveLayout="scroll"
                    [rows]="10"
                    [globalFilterFields]="['titulo_proyecto_tesis','nombre']"
                    [paginator]="true" [rowsPerPageOptions]="[10,20,30]"
                    [showCurrentPageReport]="true"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                    [(selection)]="selectedProducts" selectionMode="multiple"
                    [rowHover]="true" dataKey="id">
                    <ng-template pTemplate="caption">
                        <div
                            class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                            <h5 class="m-0">Seguimiento de inscripciones</h5>
                            <span class="block mt-2 md:mt-0 p-input-icon-left">
                                <i class="pi pi-search"></i>
                                <input pInputText type="text"
                                    (input)="onGlobalFilter(dt, $event)"
                                    placeholder="Buscar por título..."
                                    class="w-full sm:w-auto" />
                            </span>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header">
                        <tr> 
                            <th pSortableColumn="titulo_proyecto_tesis"
                                style="width:60%">Título de
                                tesis <p-sortIcon
                                    field="titulo_proyecto_tesis"></p-sortIcon></th>
                            <th pSortableColumn="nombre"
                                style="width:20%">Revisor
                                <p-sorIcon
                                    field="nombre"></p-sorIcon></th>
                            <th style="width:10%">Estado</th>
                            <th style="width:10%"></th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-data>
                        <tr>
                            <td style="width:14%; min-width:10rem;"><span
                                    class="p-column-title">Título de
                                    tesis</span>
                                {{data.titulo_proyecto_tesis}}
                            </td>
                            <td style="width:14%; min-width:8rem;">
                                <span class="p-column-title">Revisor</span>
                                {{data.inscripciones[0].docente[0].nombre + ' '
                                +
                                data.inscripciones[0].docente[0].apellidos}}
                            </td>
                            <td style="width:14%; min-width: 10rem;"><span
                                    class="p-column-title">estado</span>
                                <span
                                    [class]="'product-badge status-' + (data.estado ? data.estado.toLowerCase() : '')">{{data.inscripciones[0].estado}}</span>
                            </td>
                            <td>
                                <div class="flex">
                                    <p-button label="Ver detalle"
                                        [outlined]="true"
                                        severity="contrast"
                                        (click)="viewDetailsInscription(data)" />

                                    <!-- <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2" (click)="editProduct(product)"></button>
                                <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-warning" (click)="deleteProduct(product)"></button> -->
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
            <div *ngIf="false" class="card">
                <p-table [value]="skeletonRows" responsiveLayout="scroll">
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width:60%">Título de tesis</th>
                            <th style="width:20%">Revisor</th>
                            <th style="width:10%">Estado</th>
                            <th style="width:10%"></th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-product>
                        <tr>
                            <td><p-skeleton /></td>
                            <td><p-skeleton /></td>
                            <td><p-skeleton /></td>
                            <td><p-skeleton /></td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>

    </div>
</div>
<p-confirmDialog>
    <ng-template pTemplate="message" let-message>
        <div
            class="flex flex-column align-items-center w-full gap-3 border-bottom-1 surface-border">
            <i class="pi pi-exclamation-circle text-6xl text-primary-500"></i>
            <p>{{ message.message }}</p>
        </div>
    </ng-template>
</p-confirmDialog>
<div *ngIf="inscriptionSelected" class="grid">
    <div class="col-12">

        <div class="card">
            <div class="grid d-flex col-12">
                <div class="mr-auto p-2">
                    <p-button (click)="backList()" label="Regresar"
                        [outlined]="true"
                        icon="pi pi-angle-left" iconPos="left" />
                    <p-button *ngIf="!showEdit && inscriptionState !== 'Cancelado' && inscriptionState !== 'Aprobado'" class="ml-3"
                        (click)="showEdition()"
                        label="Editar"
                        icon="pi pi-pencil" iconPos="left" />
                    <p-button *ngIf="showEdit && inscriptionState !== 'Cancelado' && inscriptionState !== 'Aprobado'" class="ml-3"
                        (click)="cancelEdition()"
                        label="Cancelar edición"
                        icon="pi pi-times" iconPos="right" />
                    <p-button *ngIf="showEdit && inscriptionState !== 'Cancelado' && inscriptionState !== 'Aprobado'" class="ml-3"
                        (click)="saveEdition()"
                        label="Guardar cambios"
                        icon="pi pi-save" iconPos="left" />
                </div>
                <div class="p-2">
                    <p-button
                        *ngIf="inscriptionState !== 'Cancelado' && inscriptionState !== 'Aprobado'"
                        label="Cancelar inscripción"
                        [outlined]="true"
                        class="mr-3"
                        icon="pi pi-times" iconPos="left"
                        severity="danger" (click)="goToCancelation()" />
                    <p-button
                        *ngIf="inscriptionState === 'Inscrito' || inscriptionState === 'Observado'"
                        label="Pasar a revisión" [outlined]="true"
                        icon="pi pi-angle-right" iconPos="right"
                        severity="info" (click)="goToReview()" />
                    <p-button *ngIf="inscriptionState === 'En revisión'"
                        label="Observado" [outlined]="true"
                        icon="pi pi-exclamation-circle" iconPos="left"
                        severity="warning" (click)="goToObserved()" />
                    <p-button
                        *ngIf="inscriptionState === 'En revisión'"
                        class="ml-3"
                        label="Aprobado" [outlined]="true"
                        icon="pi pi-angle-right" iconPos="right"
                        severity="success" (click)="goToApprove()" />
                </div>
            </div>
            <div class="card flex justify-content-center col-12">

                <h4
                    class="font-bold">Título:
                    {{inscriptionSelected.titulo_proyecto_tesis}}</h4>

            </div>
            <div *ngIf="!showEdit" class="grid col-12">
                <div class="col-3"><p class="font-bold">Nro de
                        expediente:</p><p>{{inscriptionSelected.expediente}}</p></div>
                <div class="col-3"><p class="font-bold">Escuala
                        profesional:</p><p>{{inscriptionSelected.escuela_profesional}}</p></div>
                <div class="col-3"><p class="font-bold">Nro de
                        oficio:</p><p>{{inscriptionSelected.numero_oficio}}</p></div>
                <div class="col-3"><p class="font-bold">Nro de
                        resolución:</p><p>{{inscriptionSelected.numero_resolucion}}</p></div>
            </div>
            <div *ngIf="showEdit" class="grid col-12">
                <div class="col-3"><p class="font-bold">Nro de
                        expediente:</p><input type="text" pInputText
                        class="full-width"
                        [value]="inscriptionSelected.expediente" />
                </div>
                <div class="col-3"><p class="font-bold">Escuala
                        profesional:</p><input type="text" pInputText
                        class="full-width"
                        [value]="inscriptionSelected.escuela_profesional" />
                </div>
                <div class="col-3"><p class="font-bold">Nro de
                        oficio:</p><input type="text" pInputText
                        class="full-width"
                        [value]="inscriptionSelected.numero_oficio" />
                </div>
                <div class="col-3"><p class="font-bold">Nro de
                        resolución:</p><input type="text" pInputText
                        class="full-width"
                        [value]="inscriptionSelected.numero_resolucion" />
                </div>
            </div>
            <div class="grid col-12">
                <div class="col-3"><p class="font-bold">Fecha de recepción a
                        Facultad:</p>
                    <p *ngIf="!showEdit">
                        <i class="pi pi-calendar"></i>
                        {{inscriptionSelected.inscripciones[0].fecha_recepcion_facultad}}
                    </p>
                    <div *ngIf="showEdit" class="grid p-fluid">
                        <div class="field col-12 md:col-12">
                            <p-calendar *ngIf="showEdit"
                                [(ngModel)]="inscriptionSelected.inscripciones[0].fecha_recepcion_facultad"
                                [iconDisplay]="'input'"
                                class="full-width"
                                [showIcon]="true"
                                dateFormat="yy-mm-dd"
                                inputId="icondisplay" />
                        </div>
                    </div>

                </div>
                <div class="col-3"><p class="font-bold">Fecha de aprobación
                        UDI:</p>
                    <p *ngIf="!showEdit">
                        <i class="pi pi-calendar"></i>
                        {{inscriptionSelected.inscripciones[0].fecha_aprobacion_UDI}}
                    </p>
                    <p-calendar *ngIf="showEdit"
                        [(ngModel)]="inscriptionSelected.inscripciones[0].fecha_aprobacion_UDI"
                        [iconDisplay]="'input'"
                        class="full-width"
                        [showIcon]="true"
                        dateFormat="yy-mm-dd"
                        inputId="icondisplay" />
                </div>
                <div class="col-3">
                </div>
                <div class="card col-3">
                    <p class="font-bold">Estado:</p>
                    <p-tag *ngIf="inscriptionState === 'Inscrito'"
                        value="Inscrito" />
                    <p-tag *ngIf="inscriptionState === 'En revisión'"
                        severity="info"
                        value="En revisión" />
                    <p-tag *ngIf="inscriptionState === 'Observado'"
                        severity="warning"
                        value="Observado" />
                    <p-tag *ngIf="inscriptionState === 'Cancelado'"
                        severity="danger"
                        value="Cancelado" />
                    <p-tag *ngIf="inscriptionState === 'Aprobado'"
                        severity="success"
                        value="Aprobado" />
                </div>

            </div>
            <div class="ml-2 mr-2 separator"></div>
            <div class="grid col-12">
                <div class="col-4">
                    <p-table *ngIf="!showSelectNewReviwer"
                        [value]="inscriptionSelected.inscripciones[0].docente">
                        <ng-template pTemplate="header">
                            <tr>
                                <th><i class="pi pi-user"></i> Revisor</th>
                                <th *ngIf="showEdit" style="width: 10px;">
                                    <p-button *ngIf="showEdit"
                                    icon="pi pi-pencil"
                                    [rounded]="true" [text]="true"
                                    severity="info" />
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-product>
                            <tr>
                                <td>
                                    {{
                                        product.nombre + ' ' +
                                        product.apellidos
                                        }}
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                    <div *ngIf="showSelectNewReviwer" class="grid p-fluid mt-3">
                        <div class="field col-12 md:col-12">
                            <span class="p-float-label">
                                <p-autoComplete
                                    id="inputtext"
                                    [suggestions]="filteredReviewers"
                                    (completeMethod)="filterReviewers($event)"
                                    field="name" />
                                <label for="inputtext">Ingrese el nombre del
                                    revisor</label>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-8">

                    <p-table *ngIf="!showSelectNewReviwer"
                        [value]="inscriptionSelected.egresados">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 35%;"><i
                                        class="pi pi-users"></i>
                                    Estudiantes</th>
                                <th style="width: 35%;"></th>
                                <th style="width: 30%;">
                                    <p-button *ngIf="showEdit"
                                    icon="pi pi-pencil"
                                    [rounded]="true" [text]="true"
                                    severity="info" (click)="showEditSudents = true" />
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-product>
                            <tr>
                                <td>{{ product.nombre + ' ' + product.apellidos
                                    }}</td>
                                <td>{{ product.email }}</td>
                                <td>
                                    {{
                                        product.celular
                                    }}
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>                   
                </div>
            </div>

            <div class="ml-2 mr-2 separator"></div>
            <div class="grid col-12">
                <div class=" col-12">
                    <h5>Lista de tareas</h5>
                </div>
                <div class="col-4 text-align-center">
                    <p-card>
                        <p>Tareas incompletas <p-badge
                                [value]="totalTaskIncomplete"
                                severity="warning" />
                        </p>
                    </p-card>
                </div>
                <div class="col-4 text-align-center">
                    <p-card>
                        <p>Tareas terminadas <p-badge
                                [value]="totalTaskComplete"
                                severity="success" />
                        </p>
                    </p-card>
                </div>
                <div class="col-4 text-align-center">
                    <p-card>
                        <p>Total de tareas <p-badge [value]="totalTask"
                                severity="info" />
                        </p>
                    </p-card>
                </div>
                <div *ngIf="inscriptionState !== 'Cancelado' && inscriptionState !== 'Aprobado'" class="col-11">
                    <form [formGroup]="tasksForm">
                        <span class="p-float-label">
                            <input
                                type="text"
                                style="width: 100%;"
                                id="taskDescription"
                                pInputText
                                formControlName="taskDescription" />
                            <label for="taskDescription">Escribe la tarea
                                aquí...</label>
                        </span>
                    </form>
                </div>
                <div *ngIf="inscriptionState !== 'Cancelado' && inscriptionState !== 'Aprobado'" class="col-1">
                    <p-button label="Enviar" [rounded]="true"
                        (click)="addTask()"
                        [disabled]="tasksForm.invalid" />
                </div>

                <div class=" col-12">
                    <div *ngFor="let task of tasks" class="grid d-flex ml-1">
                        <div class="mr-auto p-2 col-11"
                            style="align-content: center;">
                            <p-checkbox
                                [inputId]="task.id"
                                [(ngModel)]="task.checked"
                                [binary]="true"
                                #checkbox
                                [disabled]="inscriptionState === 'Cancelado' || inscriptionState === 'Aprobado'"
                                (onChange)="taskDone(task.id, checkbox)"></p-checkbox>
                            <label class="ml-3" [for]="task.id"
                                [ngClass]="isTaskDone(task)">{{ task.description
                                }}</label>
                        </div>
                        <div class="p-2 col-1">
                            <p-button icon="pi pi-trash" [rounded]="true"
                                [text]="true" severity="danger"
                                [disabled]="task.checked || inscriptionState === 'Cancelado' || inscriptionState === 'Aprobado'"
                                (click)="removeTask(task.id)" />
                        </div>
                        <p-divider
                            class="col-12 divider-aditional-class"></p-divider>
                    </div>

                </div>
                <div class="ml-2 mr-2 separator"></div>

                <div class=" col-12">
                    <h5>Comentarios</h5>
                </div>
                <div class="col-12 grid">
                    <div class="mb-4 w-full flex align-items-center">
                      <p-avatar 
                          label="G" 
                          size="large" />
                      <div class="ml-3 w-full">
                        <form [formGroup]="commentsForm" style="width: inherit;">
                          <span class="p-float-label">
                              <textarea
                                  inputId="textarea"
                                  rows="3"
                                  style="width: 100%;"
                                  formControlName="comment"
                                  pInputTextarea 
                                  (keydown.enter)="addComment($event)"></textarea>
                              <label for="textarea">Escribe tu comentario
                                  aquí...</label>
                          </span>
                      </form>
                    </div>
                   
                    
                </div>
                <div class=" col-12">
                  <div *ngFor="let comment of reversedComments" class="mb-4 flex align-items-center">
                    <p-avatar 
                      [label]="getFirstLetter(comment.name)" 
                      styleClass="ml-3" 
                      size="large" />
                    <div class="ml-3 w-full">
                      <div
                        class="flex justify-content-between mb-2">
                        <span class="block text-900">
                          {{comment.name}}</span>
                        <span class="block text-700">1 Jun 17:58 pm</span>
                      </div>
                      <span
                        class="block text-900 border-1 surface-ground surface-border p-2 border-round"
                        style="word-break: break-all;">{{comment.content}}</span>
                    </div>
                  </div>
                </div>
              </div>

            </div>
        </div>
    </div>
</div>
<p-dialog
    header="Confirmación de cancelación"
    [modal]="true"
    [(visible)]="showDialogCancel"
    [style]="{ width: '50rem'}"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }">
    <div class="grid" style="height: 100%;">
        <form [formGroup]="cancelattionForm" class="col-12">
            <div class="p-fluid col-12"><p class="font-bold">Por favor seleccione la
                    fecha de recepción a
                    secretaria:</p>
                    <p-calendar 
                        [iconDisplay]="'input'"
                        class="full-width"
                        [showIcon]="true"
                        dateFormat="yy-mm-dd" />
                <!-- <p-calendar
                    class="max-w-full"
                    [inline]="true"
                    dateFormat="dd/mm/yy"
                    formControlName="dateCancelationReception">
                </p-calendar> -->
            </div>

            <div class="col-12">
                <p class="font-bold">Por favor digite el motivo de la
                    cancelación:</p>

                <textarea
                    inputId="textarea"
                    rows="5"
                    style="width: 100%;"
                    formControlName="cancelationComment"
                    pInputTextarea></textarea>

            </div>
            <p-messages [(value)]="alertForCancelation" [enableService]="false" [closable]="false" />
            <div class="footer mt-5">
                <button
                    pButton
                    pRipple
                    label="Regresar"
                    icon="pi pi-angle-left"
                    class="p-button-text"
                    iconPos="left"
                    (click)="hideCancelDialog()"></button>

                <p-button label="Confirmar cancelación" iconPos="right"
                    icon="pi pi-check" severity="danger"
                    (click)="confirmCancelation()" />

            </div>
        </form>
    </div>
</p-dialog>
<p-dialog
    header="Editar estudiantes"
    [modal]="true"
    [(visible)]="showEditSudents"
    [style]="{ width: '70rem'}">
    <div class="content">
        <div class="mt-3" style="height: 100%;">
            <div class="align-content: center;">
                <style>
                    .p-field {
                        margin-bottom: 1rem;
                    }
                    
                    .p-error-message {
                        display: flex;
                        align-items: center;
                        margin-top: 0.5rem;
                        color: #dc3545;
                    }
                    
                    .error-icon {
                        margin-right: 0.5rem;
                        font-size: 1.5rem;
                        color: #dc3545;
                    }
                    
                </style>
    
                <div [ngSwitch]="getStudentListProcess">
                    <ng-template [ngSwitchCase]="'charging'">
                        <ng-container
                            *ngTemplateOutlet="studentListSkeleton"></ng-container>
                    </ng-template>
                    <ng-template [ngSwitchCase]="'complete'">
                        <ng-container
                            *ngTemplateOutlet="studentListError"></ng-container>
                    </ng-template>
                    <ng-template [ngSwitchCase]="'error'">
                        <ng-container
                            *ngTemplateOutlet="studentList"></ng-container>
                    </ng-template>
                    <ng-template ngSwitchDefault>
                        <p>Invalid state</p>
                    </ng-template>
                </div>
                <ng-template #studentListError>
                    <div class="p-error-message">
                        <i class="pi pi-times-circle error-icon"></i>
                        <span>Ha ocurrido un error al traer la
                            información.</span>
                        <button pButton type="button"
                            icon="pi pi-refresh"
                            class="p-button-text p-button-danger"
                            (click)="callGetStudentList()"></button>
                    </div>
                </ng-template>
                <ng-template #studentListSkeleton>
                    <div class="grid p-fluid mt-3">
                        <div *ngIf="!studentsList.length"
                            class="field col-12 md:col-6">
                            <p-skeleton height="2rem"
                                styleClass="mb-2" />
                        </div>
                        <div *ngIf="!studentsList.length"
                            class="col-12 md:col-1">
                            <p-skeleton shape="circle" size="2rem"
                                styleClass="mr-2" />
                        </div>
                    </div>
                </ng-template>
                <ng-template #studentList>
                    <div class="grid p-fluid mt-3">
                        <div class="field col-12 md:col-6">
                            <span class="p-float-label">
                                <p-autoComplete
                                    id="studentOne"
                                    [suggestions]="filteredStudents"
                                    (completeMethod)="filterStudents($event)"
                                    field="name">
                                    <ng-template let-student
                                        pTemplate="item">
                                        <div
                                            class="flex align-items-center gap-2">
    
                                            <div>{{ student.name + ' ' +
                                                student.surnames}}</div>
                                        </div>
                                    </ng-template>
                                </p-autoComplete>
                                <label for="studentOne">Ingrese el
                                    nombre del
                                    estudiante</label>
                            </span>
    
                        </div>
                        <div *ngIf="!presenter.studentTwoRequired"
                            class="col-12 md:col-1">
                            <p-button icon="pi pi-user-plus"
                                [rounded]="true"
                                [outlined]="true"
                                pTooltip="Agregar un segundo estudiante"
                                tooltipPosition="bottom"
                                (click)="presenter.showStudentTwo()" />
                        </div>
                        <div *ngIf="presenter.studentTwoRequired"
                            class="col-12 md:col-5">
                            <span class="p-float-label">
                                <p-autoComplete
                                    id="studentTwo"
                                    [suggestions]="filteredSecondStudents"
                                    (completeMethod)="filterSecondStudents($event)"
                                    field="name">
                                    <ng-template let-student
                                        pTemplate="item">
                                        <div
                                            class="flex align-items-center gap-2">
    
                                            <div>{{ student.name + ' ' +
                                                student.surnames}}</div>
                                        </div>
                                    </ng-template>
                                </p-autoComplete>
                                <label for="studentTwo">Ingrese el
                                    nombre del
                                    segundo estudiante</label>
                            </span>
                        </div>
                        <div *ngIf="presenter.studentTwoRequired"
                            class="col-12 md:col-1">
                            <p-button icon="pi pi-times"
                                [rounded]="true" severity="danger"
                                [outlined]="true"
                                pTooltip="Eliminar el segundo estudiante"
                                tooltipPosition="bottom"
                                (click)="presenter.hideStudentTwo()" />
                        </div>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
    
</p-dialog>
